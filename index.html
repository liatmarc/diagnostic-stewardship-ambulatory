<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ambulatory Diagnostic Stewardship – Dashboard</title>
  <style>
    :root{
      --bg:#f8fafc; --fg:#0f172a; --muted:#475569; --card:#ffffff; --accent:#1d4ed8;
      --shadow: 0 10px 20px rgba(0,0,0,0.05);
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
    h1{font-size:1.6rem;margin:6px 0 0}
    .subtitle{color:var(--muted);margin:0}
    .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}
    @media (min-width: 900px){.grid{grid-template-columns:1fr 1fr}}
    figure{margin:0} figcaption{color:var(--muted);font-size:0.9rem;margin-top:8px}
    .badge{padding:2px 8px;border-radius:9999px;background:#e2e8f0;font-size:0.8rem}
    .downloads a{display:inline-block;margin-right:12px;margin-bottom:8px;text-decoration:none;color:var(--accent)}
    .tabs{display:flex;gap:8px;margin:10px 0 14px}
    .tab-btn{padding:8px 12px;border-radius:9999px;border:1px solid #dbe3ed;background:#fff;cursor:pointer}
    .tab-btn.active{background:#e8efff;border-color:#c7d2fe;color:#1d4ed8}
    .tab-panel{display:none}
    .tab-panel.active{display:block}

    /* NEW: Fixed-layout, 3-column table so rows align cleanly (Overview mapping only) */
    .table{width:100%;border-collapse:collapse;table-layout:fixed}
    .table th,.table td{border:1px solid #e2e8f0;padding:8px 10px;vertical-align:top;text-align:left;word-break:break-word;overflow-wrap:anywhere}
    .table th{background:#f1f5f9;font-weight:600}
    .table.zebra tbody tr:nth-child(even){background:#f8fafc}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Ambulatory Diagnostic Stewardship</h1>
        <p class="subtitle">Outpatient classification with interventions, follow-up, and outreach (simulated data)</p>
      </div>
    </header>

    <div class="card" style="margin-bottom:16px;">
      <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:center;">
        <div><span class="badge">Build:</span> (static demo)</div>
        <div><span class="badge">Source:</span> simulated data</div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="overview">Overview</button>
      <button class="tab-btn" data-tab="followup">Follow-up</button>
      <button class="tab-btn" data-tab="outreach">Outreach</button>
    </div>

    <section id="overview" class="tab-panel active">
      <div class="grid">
        <div class="card">
          <figure>
            <img src="dept_classification_stacked_amb.png" alt="Ambulatory classification stacked bar" style="width:100%;border-radius:12px;">
            <figcaption>Distribution of test classifications by department (percent of all tests).</figcaption>
          </figure>
        </div>
        <div class="card">
          <figure>
            <img src="monthly_non_actionable_rate_amb.png" alt="Monthly non-actionable rate" style="width:100%;border-radius:12px;">
            <figcaption>Monthly non-actionable diagnostic test rate.</figcaption>
          </figure>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h2 style="margin-top:0;">Category → Intervention Mapping</h2>
        <table id="map-table"></table>
      </div>

      <div class="card" style="margin-top:16px;">
        <h2 style="margin-top:0;">How this is automated</h2>
        <figure>
          <img src="diagnostic_pipeline_flowchart.png" alt="Automation flowchart" style="width:100%;border-radius:12px;max-width:900px;">
          <figcaption>Scheduler → headless pipeline → QC → charts/CSVs → dashboard.</figcaption>
        </figure>
      </div>

      <div class="card" style="margin-top:16px;">
        <h2 style="margin-top:0;">Download Data (Overview)</h2>
        <div class="downloads">
          <a href="ambulatory_tests_raw_amb.csv" download>ambulatory_tests_raw_amb.csv</a>
          <a href="ambulatory_tests_processed_amb.csv" download>ambulatory_tests_processed_amb.csv</a>
          <a href="summary_by_department_amb.csv" download>summary_by_department_amb.csv</a>
          <a href="monthly_non_actionable_rate_amb.csv" download>monthly_non_actionable_rate_amb.csv</a>
          <a href="classification_interventions_amb.csv" download>classification_interventions_amb.csv</a>
          <a href="data_quality_report_amb.csv" download>data_quality_report_amb.csv</a>
        </div>
      </div>
    </section>

    <section id="followup" class="tab-panel">
      <div class="grid">
        <div class="card">
          <figure>
            <img src="follow_up_time_distribution_amb.png" alt="Time to follow-up distribution" style="width:100%;border-radius:12px;">
            <figcaption>Days from test to follow-up for abnormal results with action.</figcaption>
          </figure>
        </div>
        <div class="card">
          <h2 style="margin-top:0;">Summary (by Department)</h2>
          <table id="follow-summary"></table>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h2 style="margin-top:0;">Download Data (Follow-up)</h2>
        <div class="downloads">
          <a href="follow_up_time_summary_amb.csv" download>follow_up_time_summary_amb.csv</a>
          <a href="follow_up_time_detail_amb.csv" download>follow_up_time_detail_amb.csv</a>
        </div>
      </div>
    </section>

    <section id="outreach" class="tab-panel">
      <div class="grid">
        <div class="card">
          <figure>
            <img src="incomplete_by_department_amb.png" alt="Incomplete tests by department" style="width:100%;border-radius:12px;">
            <figcaption>Counts of tests not completed (“Missing”) by department.</figcaption>
          </figure>
        </div>
        <div class="card">
          <h2 style="margin-top:0;">Incomplete Counts (by Department)</h2>
          <table id="outreach-counts"></table>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h2 style="margin-top:0;">Download Data (Outreach)</h2>
        <div class="downloads">
          <a href="outreach_counts_by_department_amb.csv" download>outreach_counts_by_department_amb.csv</a>
          <a href="outreach_list_amb.csv" download>outreach_list_amb.csv</a>
        </div>
      </div>
    </section>

    <p class="subtitle" style="margin-top:16px;">Static, client-side dashboard for GitHub Pages. Replace CSV/PNG files with production outputs to update.</p>
  </div>

  <script>
    // tabs
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
      });
    });

    // CSV -> table loader with optional fixed column widths
    async function loadCSVToTable(csvPath, tableEl, colPercents){
      // add fixed table styling only to the target table(s)
      tableEl.classList.add('table','zebra');

      // optional explicit column widths
      if (colPercents && colPercents.length){
        const colgroup = document.createElement('colgroup');
        colPercents.forEach(p=>{
          const col = document.createElement('col');
          col.style.width = p;
          colgroup.appendChild(col);
        });
        tableEl.appendChild(colgroup);
      }

      try{
        const res = await fetch(csvPath);
        const text = await res.text();
        const lines = text.trim().split('\n');
        if(lines.length === 0) return;

        const header = lines[0].split(',');
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        header.forEach(h=>{
          const th = document.createElement('th');
          th.textContent = h;
          trh.appendChild(th);
        });
        thead.appendChild(trh);
        tableEl.appendChild(thead);

        const tbody = document.createElement('tbody');
        for(let i=1;i<lines.length;i++){
          const tr = document.createElement('tr');
          const cells = lines[i].split(',');
          for(let j=0;j<header.length;j++){
            const td = document.createElement('td');
            td.textContent = (cells[j] ?? '').trim();
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        }
        tableEl.appendChild(tbody);
      }catch(e){
        tableEl.innerHTML = `<caption style="color:#b91c1c">Failed to load ${csvPath}</caption>`;
      }
    }

    // Load tables
    // Overview mapping table: enforce 3 fixed column widths for alignment
    loadCSVToTable('classification_interventions_amb.csv', document.getElementById('map-table'), ['18%','47%','35%']);

    // Follow-up and Outreach tables: keep default styling (no fixed widths)
    loadCSVToTable('follow_up_time_summary_amb.csv', document.getElementById('follow-summary'));
    loadCSVToTable('outreach_counts_by_department_amb.csv', document.getElementById('outreach-counts'));
  </script>
</body>
</html>
