<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ambulatory Diagnostic Stewardship Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/milligram/dist/milligram.min.css">
<style>
    body { margin: 20px; }
    nav { margin-bottom: 20px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    table { table-layout: fixed; }
    th, td { word-wrap: break-word; }
</style>
</head>
<body>

<h2>Ambulatory Diagnostic Stewardship Dashboard</h2>

<nav>
    <button onclick="openTab('overview')">Overview</button>
    <button onclick="openTab('followup')">Follow-up</button>
    <button onclick="openTab('outreach')">Outreach</button>
</nav>

<div id="overview" class="tab-content active">
    <h3>Overview Metrics</h3>
    <table id="overview-table"></table>
    <h3>Classification Mapping</h3>
    <table id="map-table"></table>
</div>

<div id="followup" class="tab-content">
    <h3>Follow-up Metrics</h3>
    <table id="followup-table"></table>
</div>

<div id="outreach" class="tab-content">
    <h3>Outreach List</h3>
    <table id="outreach-table"></table>
</div>

<script>
// Tab switching
function openTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
}

// Robust CSV parser for commas inside quotes
function parseCSV(text){
    const rows = [];
    let row = [], field = "", inQuotes = false;

    for (let i = 0; i < text.length; i++){
        const c = text[i];

        if (inQuotes){
            if (c === '"'){
                if (text[i+1] === '"'){ field += '"'; i++; } // escaped quote
                else { inQuotes = false; }
            } else {
                field += c;
            }
        } else {
            if (c === '"'){ inQuotes = true; }
            else if (c === ','){ row.push(field); field = ""; }
            else if (c === '\r'){ /* ignore */ }
            else if (c === '\n'){ row.push(field); rows.push(row); row = []; field = ""; }
            else { field += c; }
        }
    }
    row.push(field);
    if (row.length > 1 || row[0] !== "") rows.push(row);
    return rows;
}

// Load CSV to table
async function loadCSVToTable(csvPath, tableEl, colPercents){
    tableEl.classList.add('table','zebra');

    if (colPercents && colPercents.length){
        const colgroup = document.createElement('colgroup');
        colPercents.forEach(p => { const col = document.createElement('col'); col.style.width = p; colgroup.appendChild(col); });
        tableEl.appendChild(colgroup);
    }

    try {
        const res = await fetch(csvPath);
        const text = await res.text();
        const rows = parseCSV(text);
        if (!rows.length) return;

        const header = rows[0];
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        header.forEach(h => { const th = document.createElement('th'); th.textContent = h; trh.appendChild(th); });
        thead.appendChild(trh);
        tableEl.appendChild(thead);

        const tbody = document.createElement('tbody');
        for (let i = 1; i < rows.length; i++){
            const tr = document.createElement('tr');
            for (let j = 0; j < header.length; j++){
                const td = document.createElement('td');
                td.textContent = (rows[i][j] ?? "").trim();
                tr.appendChild(td);
            }
            tbody.appendChild(tr);
        }
        tableEl.appendChild(tbody);
    } catch (e) {
        tableEl.innerHTML = `<caption style="color:#b91c1c">Failed to load ${csvPath}</caption>`;
    }
}

// Load data for all tables
loadCSVToTable('overview_amb.csv', document.getElementById('overview-table'));
loadCSVToTable('classification_interventions_amb.csv', document.getElementById('map-table'), ['18%','47%','35%']);
loadCSVToTable('followup_amb.csv', document.getElementById('followup-table'));
loadCSVToTable('outreach_amb.csv', document.getElementById('outreach-table'));
</script>

</body>
</html>
